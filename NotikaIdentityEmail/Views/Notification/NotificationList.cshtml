@model List<Notification>
@{
    ViewData["Title"] = "Genel Bildiriler";
    Layout = "~/Views/UserLayout/Index.cshtml";
    var counter = 0;
}

<div class="notification-center">
    <style>
        .notification-center .notification-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(4px);
            z-index: 99999;
        }

            .notification-center .notification-modal-overlay.active {
                display: flex;
                justify-content: center;
                align-items: center;
            }

        .notification-center .notification-modal-container {
            width: min(520px, calc(100% - 32px));
            background: #fff;
            border-radius: 18px;
            padding: 28px 28px 32px;
            box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .notification-center .notification-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #0f172a;
        }

        .notification-center .notification-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }

        .notification-center .notification-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #f1f5f9;
            color: #0f172a;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

            .notification-center .notification-modal-close:hover {
                background: #e2e8f0;
            }

        .notification-center .notification-modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .notification-center .notification-image {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e2e8f0;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.15);
            background: #f8fafc;
        }

        .notification-center .notification-subject {
            width: 100%;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: #0f172a;
            margin: 0;
        }

        .notification-center .notification-detail {
            width: 100%;
            text-align: left;
            line-height: 1.7;
            color: #475569;
            font-size: 0.95rem;
            border-radius: 12px;
            background: #f8fafc;
            padding: 20px;
        }

        @@media (max-width: 576px) {
            .notification-center .notification-modal-container {
                padding: 20px;
                gap: 16px;
            }

            .notification-center .notification-image {
                width: 110px;
                height: 110px;
            }
        }
    </style>

    <div class="inbox-area">
        <div class="container">
            <div class="row">
                <div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
                    <div class="inbox-text-list sm-res-mg-t-30">
                        <div class="form-group">
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 10%;">Resim</th>
                                        <th style="width: 15%;">Gönderici</th>
                                        <th style="width: 25%;">Konu</th>
                                        <th style="width: 45%;">Detay</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        counter++;
                                        var detailText = item?.Detail ?? "";
                                        var plainText = System.Text.RegularExpressions.Regex.Replace(detailText, "<.*?>", string.Empty);
                                        var detailPreview = plainText.Length > 50
                                        ? plainText.Substring(0, 50) + "..."
                                        : plainText;

                                        <tr class="notification-row" style="cursor: pointer;">
                                            <td>@counter</td>
                                            <td>
                                                <div class="hd-message-img chat-img">
                                                    <img src="@item?.ImageUrl"
                                                         alt="Bildirim görseli"
                                                         class="notification-thumbnail"
                                                         style="width: 50px; height: 50px; object-fit: cover;" />
                                                </div>
                                            </td>
                                            <td>System</td>
                                            <td class="notification-subject-cell" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                @item?.Subject
                                            </td>
                                            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                @detailPreview
                                                <span class="notification-detail-source" hidden>
                                                    @Html.Raw(item?.Detail ?? string.Empty)
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification-modal-overlay" id="notificationModalOverlay">
        <div class="notification-modal-container">
            <div class="notification-modal-header">
                <h2 class="notification-modal-title">Bildirim Detayı</h2>
                <button type="button" class="notification-modal-close" data-close-modal>&times;</button>
            </div>
            <div class="notification-modal-body">
                <img id="notificationImage" class="notification-image" src="" alt="Bildirim Görseli">
                <p id="notificationSubject" class="notification-subject"></p>
                <div class="notification-detail" id="notificationDetail"></div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const pageRoot = document.querySelector('.notification-center');
        const overlay = pageRoot.querySelector('#notificationModalOverlay');
        const subjectEl = pageRoot.querySelector('#notificationSubject');
        const detailEl = pageRoot.querySelector('#notificationDetail');
        const imageEl = pageRoot.querySelector('#notificationImage');
        const defaultImage = '@Url.Content("~/images/default-notification.png")';

        pageRoot.querySelectorAll('.notification-row').forEach(row => {
            row.addEventListener('click', () => {
                const detailSource = row.querySelector('.notification-detail-source');
                const detailHtml = detailSource ? detailSource.innerHTML.trim() : '';
                const thumbnail = row.querySelector('.notification-thumbnail');
                const imageUrl = thumbnail ? thumbnail.getAttribute('src') : '';
                const subjectCell = row.querySelector('.notification-subject-cell');
                const subject = subjectCell ? subjectCell.textContent.trim() : '';

                showNotificationDetails(detailHtml, imageUrl, subject);
            });
        });

        overlay.addEventListener('click', evt => {
            if (evt.target === overlay) {
                closeNotificationModal();
            }
        });

        pageRoot.querySelectorAll('[data-close-modal]').forEach(button => {
            button.addEventListener('click', closeNotificationModal);
        });

        document.addEventListener('keydown', evt => {
            if (evt.key === 'Escape' && overlay.classList.contains('active')) {
                closeNotificationModal();
            }
        });

        function showNotificationDetails(detail, imageUrl, subject) {
            const subjectText = subject && subject.length > 0 ? subject : 'Belirtilmemiş';
            const detailHtml = detail && detail.length > 0 ? detail : 'Detay bulunmuyor.';

            subjectEl.textContent = subjectText;
            detailEl.innerHTML = detailHtml;

            const trimmedImage = imageUrl ? imageUrl.trim() : '';
            imageEl.onerror = () => {
                imageEl.onerror = null;
                imageEl.src = defaultImage;
            };
            imageEl.src = trimmedImage.length > 0 ? trimmedImage : defaultImage;
            imageEl.alt = `${subjectText} görseli`;

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeNotificationModal() {
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    });
</script>