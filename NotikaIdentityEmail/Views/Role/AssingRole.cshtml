@using NotikaIdentityEmail.Models.IdentityModels
@model CreateUserRoleViewModel
@{
    ViewData["Title"] = "Kullanıcı Rol Ekleme";
    Layout = "~/Views/UserLayout/Index.cshtml";
}

<div class="inbox-area">
    <div class="container">
        <div class="row">

            <form method="post" asp-action="AssingRole">
                <input asp-for="UserId" type="hidden" />

                <div class="col-lg-9 col-md-9 col-sm-8 col-xs-12">
                    <div class="view-mail-list sm-res-mg-t-30">
                        <div class="cmp-int mg-t-20">

                            <div class="row">
                                <div class="col-lg-1 col-md-2 col-sm-2 col-xs-12">
                                    <div class="cmp-int-lb cmp-int-lb1 text-right">
                                        <span>Kullanıcı: </span>
                                    </div>
                                </div>
                                <div class="col-lg-11 col-md-10 col-sm-10 col-xs-12">
                                    <div class="form-group">
                                        <div class="nk-int-st cmp-int-in cmp-email-over">
                                            <input asp-for="UserName" class="form-control" readonly />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-1 col-md-2 col-sm-2 col-xs-12">
                                    <div class="cmp-int-lb cmp-int-lb1 text-right">
                                        <span>Rol: </span>
                                    </div>
                                </div>
                                <div class="col-lg-11 col-md-10 col-sm-10 col-xs-12">
                                    <div class="form-group">
                                        <div class="nk-int-st cmp-int-in cmp-email-over">
                                            <select asp-for="RoleId" class="form-control" asp-items="ViewBag.v">
                                                <option value=""> -- Rol Seçiniz -- </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <button type="submit" class="btn btn-info">Rolü Ata</button>

                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    </div>
                </div>
            </form>
            <hr />
            <div class="col-lg-9 col-md-9 col-sm-8 col-xs-12">
                <hr />
                <h4>Kullanıcının Rolleri</h4>

                <div id="userRolesContainer">
                    Yükleniyor...
                </div>
            </div>

        </div>
    </div>
</div>


<form id="ajaxAntiForgeryForm">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        $(function () {

            var userId = '@Model.UserId';
            var token = $('#ajaxAntiForgeryForm input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '@Url.Action("GetUserRole", "Role")',
                type: 'POST',
                data: {
                    id: userId,
                    __RequestVerificationToken: token
                },
                success: function (res) {
                    var container = $('#userRolesContainer');

                    if (!res || !res.success) {
                        container.html((res && res.message) ? res.message : 'Rol bilgisi alınamadı.');
                        return;
                    }

                    if (!res.data || res.data.length === 0) {
                        container.html('Bu kullanıcıya atanmış rol bulunamadı.');
                        return;
                    }

                    var html = '';
                    html += '<table class="table table-sm table-striped table-bordered mb-0">';
                    html += '  <thead>';
                    html += '    <tr>';
                    html += '      <th>Role Name</th>';
                    html += '      <th>İşlem</th>';
                    html += '    </tr>';
                    html += '  </thead>';
                    html += '  <tbody>';

                    $.each(res.data, function (i, item) {
                        html += '<tr>';
                        html += '  <td>' + item.name + '</td>';
                        html += '  <td>';
                        html += '    <form method="post" action="@Url.Action("RemoveRole", "Role")" style="display:inline;">';
                        html += '      <input type="hidden" name="UserId" value="' + userId + '" />';
                        html += '      <input type="hidden" name="RoleId" value="' + item.roleId + '" />';
                        html += '      <input type="hidden" name="__RequestVerificationToken" value="' + token + '" />';
                        html += '      <button type="submit" class="btn btn-danger btn-sm">Rolü Sil</button>';
                        html += '    </form>';
                        html += '  </td>';
                        html += '</tr>';
                    });

                    html += '  </tbody>';
                    html += '</table>';

                    container.html(html);
                },
                error: function () {
                    $('#userRolesContainer').html('Sunucu hatası oluştu.');
                }
            });

        });
    </script>
}
